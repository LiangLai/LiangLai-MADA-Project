---
title: "Cleaning and processing code for HRS data"
author: "Liang Lai"
date: "2026-02-27"
output: html_document
---

# Setup
Load needed packages. make sure they are installed.
```{r}
library(readxl) #for loading Excel files
library(dplyr) #for data processing/cleaning
library(tidyr) #for data processing/cleaning
library(skimr) #for nice visualization of data 
library(here) #to set paths
library(haven) # for load stata data
library(stringr)
```

# Data loading
Link to the HRS data: <https://hrsdata.isr.umich.edu/data-products/long-format-data-rand-hrs-longitudinal-file-2020>. 
In this link, you can find the long format data files (rlong, hlong, rwide) that we will use for this project. You can also find the codebook and documentation for these datasets in the same link.

Link to the lange weir cognition data: <https://hrsdata.isr.umich.edu/data-products/langa-weir-classification-cognitive-function-1995-2022>. This dataset contains the cognitive classification variable (cogimp) that we will use to determine dementia status in our analysis. We will merge this cognition data with the main HRS data later in the cleaning process. However, the cognition data is in wide format and we will need to reshape it to long format before merging.
```{r}
# load HRS data (long format)  
rlong <- read_sas(here("data", "raw-data", "rlong_table.sas7bdat"))
hlong <- read_sas(here("data", "raw-data", "hlong_table.sas7bdat"))
rwide <- read_sas(here("data", "raw-data", "rwide_table.sas7bdat"))

# load lange weir data 
lange_weir_raw <- read_dta(here("data","raw-data","cogfinalimp_9522wide.dta"))
```

```{r}
# check all overlapping columns
overlap_cols <- c(
  intersect(names(rlong), names(hlong)),
  intersect(names(rlong), names(rwide)),
  intersect(names(hlong), names(rwide))
) %>% 
  unique() %>%
  setdiff(c("HHIDPN", "WAVE_NUMBER"))

# Drop overlapping columns from hlong and rwide, then merge
hrs_long <- rlong %>%
  full_join(hlong %>% select(-any_of(overlap_cols)), by = c("HHIDPN", "WAVE_NUMBER")) %>%
  left_join(rwide %>% select(-any_of(overlap_cols)), by = "HHIDPN") %>%
  arrange(HHIDPN, WAVE_NUMBER)

rm(rlong, hlong, rwide)
```

```{r}
#  Sample code to select 1000 random rows from the raw data and save as a new RDS file for testing and sharing within the class repository.
set.seed(123) 
hrs_sample <- hrs_long %>%
  slice_sample(n = 1000)

# 3. save to processed-data 
saveRDS(hrs_sample, here("data", "processed-data", "randhrs_sample_1000.rds"))
```


# Check data 
First we can look at the data. For the main HRS data, we have 280,343 observations about 42405 unique individuals (HHIDPN) across 16 waves. The large number of observations is due to the longitudinal structure of HRS, where each person can have multiple rows corresponding to different survey waves. 

```{r}
glimpse(hrs_long)
head(hrs_long)
hrs_long %>% 
  summarise(total_people = n_distinct(HHIDPN))
```

```{r}
glimpse(lange_weir_raw)
head(lange_weir_raw)
```

# Cleaning

Next, follow the following steps to process the data:

1. Reshape the data of lange_weir from wide to long format.
```{r}
# Variable stubs (without year suffix)
cog_stubs <- c("bwc20_imp", "cogfunction", "cogivewmode", "cogtot27_imp",
               "dlrc_imp", "fbwc20_imp", "fdlrc_imp", "fimparate_imp",
               "fimrc_imp", "fmemoryp_imp", "fnumiadl_imp", "fser7_imp",
               "imparate_imp", "imrc_imp", "interview",
               "memoryp_imp", "numiadl_imp", "proxy", "prxyscore_imp", "ser7_imp")    

# reshape lange weir data from wide to long format
lange_weir_long <- lange_weir_raw %>%
  pivot_longer(
    cols = matches(paste0(cog_stubs, collapse = "|")),
    names_to = c(".value", "studyyr"),
    names_pattern = paste0("^(", paste(cog_stubs, collapse = "|"), ")(\\d{4})$")
  ) %>%
  mutate(studyyr = as.integer(studyyr)) %>%
  # Keep only those interviewed in that wave (same as SAS/Stata code)
  filter(interview == 1) %>%
  arrange(hhid, pn, studyyr)
```

2. Merge the lange weir data with the main HRS data. Before merging, we need to make sure that the key variables for merging (HHIDPN and studyyr) are in the same format in both datasets. In the main HRS data, we have HHIDPN and STUDYYR variables, while in the lange weir data, we have hhid, pn, and studyyr. And we should limit the year from 1996 to 2020 to match the waves in the main HRS data to make sure consistency.  
We will merge them by person (HHIDPN) and year.
```{r}
# limit the year from 1996 to 2020 to match the waves in the two datasets
# Remove .y columns (keep .x as primary)
hrs_long_filtered <- hrs_long %>%
  filter(STUDYYR >= 1996 & STUDYYR <= 2020)
lange_weir_filtered <- lange_weir_long %>%
  filter(studyyr >= 1996 & studyyr <= 2020)
```
```{r}
# creat HHIDPN variable in lange weir data 
lange_weir_filtered <- lange_weir_filtered %>%
  mutate(HHIDPN = as.numeric(paste0(hhid, pn)),
         STUDYYR = studyyr) %>%   # Rename to match HRS column name
  select(-hhid, -pn, -studyyr)    # Drop old ID columns
```
```{r}
# merge the two datasets
hrs_cog <- hrs_long_filtered %>%
  left_join(lange_weir_filtered, by = c("HHIDPN", "STUDYYR"))
```

3. Select the variables needed for the analysis.
```{r}
# ── Select only variables needed based on codebook ────────────────────────
hrs_cog_clean <- hrs_cog %>%
  select(
    # Key ID and wave variables
    HHIDPN, STUDYYR, WAVE_NUMBER,
    # Time-invariant demographics (from rwide)
    RABYEAR,       # Birth year
    RARACEM,       # Race
    RAHISPAN,      # Ethnicity
    RAEDUC,        # Education
    RAGENDER,      # Gender
    RAWTSAMP,      # Sampling weight
   
   # Respondent wave-varying health variables (from rlong)
    R_MSTAT,       # Marital status
    R_BMI,         # BMI (self-reported)
    R_PMBMI,       # BMI (physically measured, 2006-2018)
    R_HIBP,        # Hypertension
    R_DIAB,        # Diabetes
    R_CANCR,       # Cancer
    R_LUNG,        # Chronic lung disease
    R_HEART,       # Heart disease
    R_STROK,       # Stroke
    R_DEPRES,      # Depression (CESD)
    R_SMOKEV,      # Ever smoked
    R_SMOKEN,      # Smokes now
    R_DRINKD,      # Days/week drinks (1996-2020)
    R_DRINKN,      # Drinks/day
    R_LBRF,        # Labor force status
    R_HIGOV,       # Covered by government health plan
    R_GOVMR,       # Medicare
    R_GOVMD,       # Medicaid
    R_GOVVA,       # Champus/VA
    R_GOVOT,       # Other government plan
    R_PRPCNT,      # Number of private health insurance plans
    R_COVR,        # Covered by employer health insurance
    R_COVS,        # Covered by spouse employer health insurance
    R_HIOTHP,      # Other health insurance
    R_HILTC,       # Long-term care insurance
    
    # Household wave-varying variables (from hlong)
    H_HHRES,       # Number of people in household
    H_ATOTB,       # Net total wealth
    H_ITOT,        # Total household income

    # Cognitive variables (from lange-weir)
    cogfunction,   # Outcome: cognition category (1=Normal, 2=CIND, 3=Demented)
    cogtot27_imp,  # 27-point cognitive total score
    cogivewmode,   # Interview mode
    proxy,         # Proxy respondent type
    imrc_imp,      # Immediate word recall
    dlrc_imp,      # Delayed word recall
    ser7_imp,      # Serial 7s
    bwc20_imp,     # Backwards count
  )
```

4. Check missing values for each variable
```{r}
# Check missing values for each variable
missing_summary <- hrs_cog_clean %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(everything(), 
               names_to = "variable", 
               values_to = "n_missing") %>%
  mutate(pct_missing = round(n_missing / nrow(hrs_cog_clean) * 100, 1)) %>%
  arrange(desc(pct_missing))
print(missing_summary)
# Delete variables with more than 50% missing values 
hrs_cog_clean <- hrs_cog_clean %>%
  select(-c(R_GOVOT, R_PMBMI, RAWTSAMP, cogivewmode)) 
```

5. Create some new variables and recode some variables based on the codebook and variable distributions. 
```{r}
# Create HAS_ANY_INSURANCE variable (0/1/NA)
# 1 = has any insurance (Medicare, Medicaid, VA, or any private plan), 0 = no insurance
# NA = all insurance variables are missing
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(
    HAS_INS = case_when(
      R_GOVMR == 1 | R_GOVMD == 1 |
      R_GOVVA == 1 |
      (R_PRPCNT >= 1 & !is.na(R_PRPCNT))        ~ 1,         # Confirmed has insurance
      is.na(R_GOVMR) & is.na(R_GOVMD) &
      is.na(R_GOVVA) & is.na(R_PRPCNT)           ~ NA_real_,  # All missing → NA
      TRUE                                        ~ 0          # Confirmed no insurance
    ) %>%
    factor(levels = 0:1,
           labels = c("No insurance", "Has insurance"))
  ) %>%
  # Recode chronic condition variables and recode chronic condition variables to binary (1=Yes, 0=No/other), then count number of chronic conditions.
  mutate(across(c(R_HIBP, R_DIAB, R_CANCR, R_LUNG, R_HEART, R_STROK),
                ~ case_when(. %in% c(1, 3, 6) ~ 1,   # Yes or disputed but has condition
                            . %in% c(0, 4) ~ 0,   # No or disputed but no condition
                            . == 5         ~ NA_real_,  # Unknown 
                            TRUE           ~ NA_real_), # Other missing codes
                .names = "{.col}_bin")) %>%
  # Count number of chronic conditions
  mutate(CHRONIC_N = rowSums(select(., ends_with("_bin")), na.rm = TRUE))

# Check distribution
table(hrs_cog_clean$HAS_INS, useNA = "always")

# Create age variable at time of interview and filter to HRS target population (50+)
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(AGE = STUDYYR - RABYEAR) %>%
  filter(AGE >= 50)

# Check distribution
summary(hrs_cog_clean$AGE)
```

```{r}
# Create RACE_ETH3 variable (Race/Ethnicity 3 categories)
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(
    RACE_ETH3 = case_when(
      RAHISPAN == 0 & RARACEM == 1 ~ 1,  # Non-Hispanic White
      RAHISPAN == 0 & RARACEM == 2 ~ 2,  # Non-Hispanic Black
      RAHISPAN == 0 & RARACEM == 3 ~ 3,  # Hispanic or Other
      RAHISPAN == 1                ~ 3,  # Hispanic or Other
      TRUE                         ~ NA_real_
    ) %>%
    factor(levels = 1:3, 
           labels = c("Non-Hispanic White", "Non-Hispanic Black", "Hispanic or Other"))
  )

# Check distribution
table(hrs_cog_clean$RACE_ETH3, useNA = "always")
```

```{r}
# Recode RAEDUC: merge category 5 into 4 (College and above)
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(
    RAEDUC = case_when(
      RAEDUC %in% c(4, 5) ~ 4,  # Merge "Some college" and "College and above" into "College or above"
      TRUE                ~ RAEDUC
    ) %>%
    factor(levels = 1:4,
           labels = c("Less than high school", "GED", 
                      "High school graduate", "College or above"))
  )

# Check distribution
table(hrs_cog_clean$RAEDUC, useNA = "always")
```

```{r}
# Create SMOKESTATUS variable based on R_SMOKEV: 0=Never smoker, 1=Ever/Current smoker, NA=Missing/Unknown 
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(
    SMOKESTATUS = case_when(
      R_SMOKEV == 0 ~ 0,  # Never smoker
      R_SMOKEV == 1 ~ 1,  # Ever/Current smoker
      TRUE          ~ NA_real_
    ) %>%
    factor(levels = 0:1, labels = c("Never smoker", "Ever/Current smoker"))
  )
```

```{r}
# Create EMP_STATUS variable (Employment status)
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(
    EMP_STATUS = case_when(
      R_LBRF %in% c(1, 2) ~ 1,  # Employed (FT/PT)
      R_LBRF %in% c(3, 7) ~ 2,  # Unemployed/Not in labor force
      R_LBRF %in% c(4, 5) ~ 3,  # Retired
      R_LBRF == 6          ~ 4,  # Disabled
      TRUE                 ~ NA_real_
    ) %>%
    factor(levels = 1:4,
           labels = c("Employed (FT/PT)", "Unemployed/Not in labor force",
                      "Retired", "Disabled"))
  )

# Check distribution
table(hrs_cog_clean$EMP_STATUS, useNA = "always")
```

```{r}
# Create LN_HITOT variable (Log total income + 1)
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(LN_HITOT = log(H_ITOT + 1))  # Log(income + 1) 

# Check distribution
summary(hrs_cog_clean$LN_HITOT)
```

```{r}
# Create LN_WEALTH variable using asinh transformation
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(LN_WEALTH = asinh(H_ATOTB))

# Check distribution
summary(hrs_cog_clean$LN_WEALTH)
```
```{r}
# Convert R_DEPRES to factor
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(
    R_DEPRES = factor(R_DEPRES,
                      levels = 0:1,
                      labels = c("No", "Yes"))
  )

# Check distribution
table(hrs_cog_clean$R_DEPRES, useNA = "always")
```

```{r}
# Create BMI_CAT variable (BMI categories)
hrs_cog_clean <- hrs_cog_clean %>%
  mutate(
    BMI_CAT = case_when(
      R_BMI < 18.5               ~ 1,  # Thin
      R_BMI >= 18.5 & R_BMI < 25 ~ 2,  # Normal
      R_BMI >= 25   & R_BMI < 30 ~ 3,  # Overweight
      R_BMI >= 30                ~ 4,  # Obese
      TRUE                       ~ NA_real_
    ) %>%
    factor(levels = 1:4,
           labels = c("Thin (<18.5)", "Normal (18.5-24.9)",
                      "Overweight (25.0-29.9)", "Obese (>=30.0)"))
  )

# Check distribution
table(hrs_cog_clean$BMI_CAT, useNA = "always")
```

```{r}
# Create baseline variables from 1996 wave
baseline <- hrs_cog_clean %>%
  filter(STUDYYR == 1996) %>%
  select(HHIDPN,
         BASELINE_AGE = AGE,      # Age at baseline (1996)
         BASELINE_BMI = R_BMI)    # BMI at baseline (1996)

# Merge baseline back to main dataset
hrs_cog_clean <- hrs_cog_clean %>%
  left_join(baseline, by = "HHIDPN") %>%
  # Drop people with no baseline (not interviewed in 1996)
  filter(!is.na(BASELINE_AGE) & !is.na(BASELINE_BMI))
```


At this point, we select only the variables needed for the regression analysis (may edit later).

```{r}
# Toupper all variable names
hrs_cog_clean <- hrs_cog_clean %>%
  rename_with(toupper)
  
# Select only variables needed for regression analysis
hrs_cog_final <- hrs_cog_clean %>%
  select(
    # ID and wave variables
    HHIDPN, STUDYYR, WAVE_NUMBER,
    # Outcome variables
    COGFUNCTION,    # Cognitive status (1=Normal, 2=CIND, 3=Demented)
    COGTOT27_IMP,   # 27-point cognitive total score
    # Main predictor
    BMI_CAT,        # BMI categories
    R_BMI,          # BMI continuous
    # Covariates
    BASELINE_AGE, 
    BASELINE_BMI,   
    AGE,            # Age at interview
    RAGENDER,       # Gender
    LN_WEALTH,      # Log household wealth
    CHRONIC_N,      # Number of chronic conditions
    RAEDUC,         # Education
    RACE_ETH3,      # Race/ethnicity
    HAS_INS,        # Health insurance
    EMP_STATUS,     # Employment status
    SMOKESTATUS,    # Smoking status
    R_DEPRES,       # Depression
    LN_HITOT        # Log total income
  )
```

# Save data 
Finally, we save the clean data as RDS file. I suggest you save your processed and cleaned data as RDS or RDA/Rdata files. 
```{r}
saveRDS(hrs_cog_final, here("data", "processed-data", "hrs_cognition_final.rds"))
```


# Notes

